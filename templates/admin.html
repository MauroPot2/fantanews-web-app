{% extends "base.html" %}

{% block title %}Pannello Admin{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="display-6 fw-bold text-primary mb-3">‚öôÔ∏è Pannello Amministrazione</h2>
            <p class="lead text-muted">Carica tabellini Excel e monitora l'elaborazione in tempo reale</p>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>{{ total_matches | default(0) }}</h3>
                    <small>Partite Totali</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3>{{ total_articles | default(0) }}</h3>
                    <small>Articoli Generati</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3>{{ total_teams | default(0) }}</h3>
                    <small>Squadre</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3>{{ latest_gameweek | default('N/A') }}</h3>
                    <small>Ultima Giornata</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="row">
        <!-- Upload Form -->
        <div class="col-lg-6 mb-4">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-upload me-2"></i>Carica Tabellino Excel</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" method="POST" action="{{ url_for('admin_process') }}" enctype="multipart/form-data">
                        
                        <!-- File Upload -->
                        <div class="mb-3">
                            <label for="file" class="form-label fw-bold">üìã File Excel</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls" required>
                            <div class="form-text">Formato supportato: Excel (.xlsx, .xls) - Max 10MB</div>
                        </div>
                        
                        <!-- Gameweek -->
                        <div class="mb-3">
                            <label for="gameweek" class="form-label fw-bold">üìÖ Giornata</label>
                            <input type="number" class="form-control" id="gameweek" name="gameweek" min="1" max="38" value="{{ suggested_gameweek | default(1) }}" required>
                        </div>
                        
                        <!-- Options -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">üîß Opzioni</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generateArticles" name="generate_articles" checked>
                                <label class="form-check-label" for="generateArticles">ü§ñ Genera articoli AI</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="updateStandings" name="update_standings" checked>
                                <label class="form-check-label" for="updateStandings">üìä Aggiorna classifica</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="overwriteDuplicates" name="overwrite_duplicates">
                                <label class="form-check-label" for="overwriteDuplicates">üîÑ Sovrascrivi duplicati</label>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <span id="submitText">üöÄ Elabora Tabellino</span>
                                <div class="spinner-border spinner-border-sm ms-2 d-none" id="submitSpinner"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">‚ö° Azioni Rapide</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('matches') }}" class="btn btn-outline-primary">‚öΩ Vedi Partite</a>
                        <a href="{{ url_for('articles') }}" class="btn btn-outline-success">üì∞ Vedi Articoli</a>
                        <a href="{{ url_for('standings') }}" class="btn btn-outline-info">üìä Classifica</a>
                        <hr>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearDatabase()">üóëÔ∏è Svuota Database</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ‚úÖ LOG STREAMING LIVE -->
        <div class="col-lg-6 mb-4">
            <div class="card border-success">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìã Log Elaborazione</h5>
                    <div>
                        <span class="badge bg-light text-dark" id="connectionStatus">üîå Connessione...</span>
                        <button class="btn btn-sm btn-light ms-2" onclick="clearLogs()">üßπ</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="logContainer" class="log-container">
                        <div class="p-3 text-muted">üì° Connessione al log stream...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ JavaScript SSE senza polling -->
<script>
let logEventSource = null;
let logContainer = null;

document.addEventListener('DOMContentLoaded', function() {
    logContainer = document.getElementById('logContainer');
    connectToLogStream();
});

function connectToLogStream() {
    if (logEventSource) {
        logEventSource.close();
    }
    
    // ‚úÖ Server-Sent Events - niente polling!
    logEventSource = new EventSource('{{ url_for("admin_log_stream") }}');
    
    logEventSource.onopen = function() {
        console.log('üì° Log stream connesso');
        updateConnectionStatus('üü¢ Connesso', 'success');
        addLogEntry('üì° Connesso al log stream', 'INFO', true);
    };
    
    logEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            
            // Ignora heartbeat
            if (data.type === 'heartbeat') {
                return;
            }
            
            addLogEntry(data.message, data.level, false, data.timestamp);
            
        } catch (e) {
            console.error('Errore parsing log:', e);
        }
    };
    
    logEventSource.onerror = function() {
        console.log('‚ùå Errore log stream');
        updateConnectionStatus('üî¥ Errore', 'danger');
        
        // Riconnetti dopo 3 secondi
        setTimeout(() => {
            console.log('üîÑ Riconnessione log stream...');
            connectToLogStream();
        }, 3000);
    };
}

function updateConnectionStatus(text, type) {
    const status = document.getElementById('connectionStatus');
    status.textContent = text;
    status.className = `badge bg-${type} text-white`;
}

function addLogEntry(message, level = 'INFO', isSystem = false, timestamp = null) {
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${level.toLowerCase()} ${isSystem ? 'system' : ''}`;
    
    const time = timestamp || new Date().toLocaleTimeString();
    const icon = getLogIcon(level);
    
    logEntry.innerHTML = `
        <div class="log-content">
            <span class="log-time">${time}</span>
            <span class="log-level">${icon} ${level}</span>
            <span class="log-message">${message}</span>
        </div>
    `;
    
    // Aggiungi al container
    if (logContainer.children.length === 1 && logContainer.children[0].textContent.includes('Connessione')) {
        logContainer.innerHTML = '';
    }
    
    logContainer.appendChild(logEntry);
    
    // Scroll automatico
    logContainer.scrollTop = logContainer.scrollHeight;
    
    // Mantieni max 100 log
    while (logContainer.children.length > 100) {
        logContainer.removeChild(logContainer.firstChild);
    }
}

function getLogIcon(level) {
    switch(level.toUpperCase()) {
        case 'SUCCESS': return '‚úÖ';
        case 'ERROR': return '‚ùå';
        case 'WARNING': return '‚ö†Ô∏è';
        case 'INFO': default: return '‚ÑπÔ∏è';
    }
}

function clearLogs() {
    logContainer.innerHTML = '<div class="p-3 text-muted">üìã Log puliti</div>';
}

// Form submission
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('file');
    if (!fileInput.files[0]) {
        alert('Seleziona un file Excel!');
        return;
    }
    
    if (fileInput.files[0].size > 10 * 1024 * 1024) {
        alert('File troppo grande! Max 10MB');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Elaborazione in corso...';
    submitSpinner.classList.remove('d-none');
    
    // Submit form
    const formData = new FormData(this);
    
    fetch('{{ url_for("admin_process") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLogEntry('üöÄ Upload completato - elaborazione avviata', 'SUCCESS', true);
        } else {
            addLogEntry(`‚ùå Errore: ${data.message}`, 'ERROR', true);
            alert(`Errore: ${data.message}`);
        }
    })
    .catch(error => {
        addLogEntry(`‚ùå Errore di rete: ${error.message}`, 'ERROR', true);
        alert(`Errore: ${error.message}`);
    })
    .finally(() => {
        // Reset form
        submitBtn.disabled = false;
        submitText.textContent = 'üöÄ Elabora Tabellino';
        submitSpinner.classList.add('d-none');
    });
});

// Quick actions
function clearDatabase() {
    if (confirm('‚ö†Ô∏è ATTENZIONE: Cancellare tutti i dati?')) {
        if (confirm('Sei sicuro? Azione irreversibile!')) {
            fetch('{{ url_for("clear_database") }}', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Database svuotato');
                    location.reload();
                } else {
                    alert('‚ùå Errore: ' + data.message);
                }
            });
        }
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (logEventSource) {
        logEventSource.close();
    }
});
</script>
{% endblock %}
